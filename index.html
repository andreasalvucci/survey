<html>

<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />

    <script src="https://unpkg.com/materialize-stepper@3.1.0/dist/js/mstepper.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/materialize-stepper@3.1.0/dist/css/mstepper.min.css">


    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>

    <style>
        .btn,
        .btn-large,
        .btn-small,
        .btn-flat {
            border-radius: 4px;
            font-weight: 500;
        }
        
        .card:hover {
            box-shadow: 0px 10px 35px 0px rgba(0, 0, 0, 0.18);
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0px 5px 25px 0px rgba(0, 0, 0, 0.15);
        }
    </style>


    <title>Sono vittima?</title>
</head>

<body>
    <script type="text/javascript" src="./stepper.min.js"></script>
    <div class="section grey lighten-5">
        <div class="container">
            <div class="row">

                <h3 class="light center-align blue-text">Sign up form</h3>
                <div class="card">
                    <div class="card-content">


                        <ul class="stepper horizontal linear">
                            <li class="step active">
                                <span class="mdl-step__label">
              <span class="mdl-step__title">
                <span class="mdl-step__title-text">E-mail</span>
                                </span>
                                </span>
                                <div class="step-content">
                                    <div class="row">
                                        <div class="input-field col s12">
                                            <input id="email" name="email" type="email" class="validate" required>
                                            <label for="email">La tua e-mail</label>
                                        </div>
                                    </div>
                                    <div class="step-actions">
                                        <button class="waves-effect waves-dark btn blue next-step" onclick="myAPI()" data-feedback="anyThing">Continue</button>
                                    </div>
                                </div>
                            </li>

                            <li class="step">
                                <div class="step-title waves-effect waves-dark">Risultato</div>
                                <div class="step-content">
                                    <div class="row">
                                        <div id="risultato"></div>
                                        <div id="divLista"></div>

                                    </div>

                                    <button id="continuaAlSondaggio" class="waves-effect waves-dark btn blue next-step">Continua</button>
                                    <button class="waves-effect waves-dark btn-flat previous-step">BACK</button>
                                </div>
                            </li>

                            <li class="step">
                                <div class="step-title waves-effect waves-dark">Sondaggio</div>
                                <div class="step-content">
                                    <p>Ti chiediamo per favore di compilare questo sondaggio.</p>
                                    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdpKfmASI77RfLYmZoDBOXBVYXWsIDFGVQyP0W84Ix0vNmaNQ/viewform?embedded=true" width=100% height="675" frameborder="0" marginheight="0" marginwidth="0">Caricamento…</iframe>
                                </div>
                                <div class="step-actions">
                                    <button class="waves-effect waves-dark btn-flat previous-step">BACK</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="text/javascript">
        if (!(typeof(componentHandler) == 'undefined')) {
            componentHandler.upgradeAllRegistered();
        }

        function anyThing(destroyFeedback) {
            setTimeout(function() {
                destroyFeedback(true);
            }, 1500);
        }

        function noThing(destroyFeedback) {
            setTimeout(function() {
                destroyFeedback(true);
            }, 10000);
        }

        var stepperDiv = document.querySelector('.stepper');
        console.log(stepperDiv);
        var stepper = new MStepper(stepperDiv);
    </script>


    <script type="text/javascript">
        function myAPI() {
            pulisciStep2();
            email = document.getElementById("email").value;

            console.log('la mail selezionata e' + email)


            fetch('./hibp?email=' + email)
                .then(response => response.json())
                .then(data => printBreach(data))
                .catch(e => console.log(e));


        }

        function pulisciStep2() {
            divRisultato = document.getElementById("risultato");
            divRisultato.innerHTML = "";

            divLista = document.getElementById("divLista");
            divLista.innerHTML = "";

            bottoneAlSondaggio = document.getElementById("continuaAlSondaggio");
            bottoneAlSondaggio.disabled = false;
        }



        function printBreach(data) {
            console.log(data.ok);
            if (data.ok == "ok") {
                divRisultato = document.getElementById("risultato");
                h3Risultato = document.createElement('h3');
                pRisultato = document.createElement('p');
                pRisultato.innerHTML = "Il tuo indirizzo e-mail non risulta in nessuno dei data breach a nostra conoscenza. Puoi provare con un" +
                    " altro indirizzo o abbandonare il sito. Grazie!";
                h3Risultato.innerHTML = "Buone notizie!";
                divRisultato.appendChild(h3Risultato);
                divRisultato.appendChild(pRisultato);
                bottoneAlSondaggio = document.getElementById("continuaAlSondaggio");
                bottoneAlSondaggio.disabled = "true";
            } else {
                divRisultato = document.getElementById("risultato");
                h3Risultato = document.createElement('h3');
                pRisultato = document.createElement('p');
                pRisultato.innerHTML = "Il tuo indirizzo e-mail è stato trovato in " + data.length + " data breach. Di seguito la lista.";
                h3Risultato.innerHTML = "Pessime notizie!";
                divRisultato.appendChild(h3Risultato);
                divRisultato.appendChild(pRisultato);
                divLista = document.getElementById("divLista");
                lista = document.createElement('ul');
                lista.className = "collection";
                divLista.appendChild(lista);
                console.log(data);
                for (i in data) {
                    breach = data[i];
                    elemento = document.createElement('li');
                    elemento.className = "collection-item";
                    lista.appendChild(elemento);
                    elemento.innerHTML = elemento.innerHTML + breach.Name;
                }
            }
        }
    </script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
</body>

</html>