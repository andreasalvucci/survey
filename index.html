<!DOCTYPE html>

<head>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/survey-jquery@1.9.5/survey.jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" media="screen,projection" />

    <script src="https://unpkg.com/materialize-stepper@3.1.0/dist/js/mstepper.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/materialize-stepper@3.1.0/dist/css/mstepper.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <style>
        blockquote {
            border-left: 5px solid #2196f3;
        }
        
        .btn,
        .btn-large,
        .btn-small,
        .btn-flat {
            border-radius: 4px;
            font-weight: 500;
        }
        
        .card:hover {
            box-shadow: 0px 10px 35px 0px rgba(0, 0, 0, 0.18);
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0px 5px 25px 0px rgba(0, 0, 0, 0.15);
        }
    </style>


    <title>Sono vittima?</title>
</head>

<body>
    <script type="text/javascript" src="./stepper.min.js"></script>
    <div class="section grey lighten-5">
        <div class="container">
            <div class="row">


                <h3 class="light center-align blue-text">Dove sono i miei dati?</h3>
                <div class="card">
                    <div class="card-content">


                        <ul class="stepper horizontal linear">

                            <li class="step active">
                                <div class="step-title waves-effect waves-dark">Introduzione</div>
                                <div class="step-content">
                                    <div class="row">
                                        <blockquote>
                                            Benvenut*! Sto conducendo un'indagine sulle reazioni delle persone quando vengono a conoscenza di essere state <b>vittime di data breach</b>. Un data breach è una violazione di sicurezza che comporta - accidentalmente
                                            o in modo illecito - la distruzione, la perdita, la modifica, la divulgazione non autorizzata o l’accesso ai dati personali trasmessi, conservati o comunque trattati.
                                        </blockquote>
                                        <blockquote>
                                            Nei prossimi passaggi potrai scoprire se sei mai stat* vittima di un data breach e potrai sapere quali e quanti. Alla fine ti chiederò di compilare un piccolo questionario che mi sarà molto utile.
                                        </blockquote>
                                        <blockquote>
                                            D'accordo? Fai tap o clicca su Avanti!
                                        </blockquote>

                                        <blockquote>
                                            Ci tengo a ricordarti che <b>in nessun modo</b> alcuno dei tuoi dati che fornirai verrà salvato. Il sondaggio finale è <b>anonimo</b>.
                                        </blockquote>
                                    </div>
                                    <div class="step-actions">
                                        <button class="waves-effect waves-dark btn blue next-step" data-feedback="anyThing">Avanti</button>
                                    </div>
                                </div>
                            </li>
                            <li class="step">
                                <div class="step-title waves-effect waves-dark">La tua e-mail</div>
                                <div class="step-content">
                                    <div class="row">
                                        <blockquote>Inserisci qui il tuo indirizzo e-mail che usi più di frequente (ad esempio per registrarti ad un sito). Ancora una volta ti ricordiamo che <b>non verrà conservato</b> da nessuna parte, nel rispetto della tua privacy.
                                        </blockquote>
                                        <div class="input-field col s12">
                                            <input id="email" name="email" type="email" class="validate" required>
                                            <label for="email">La tua e-mail</label>
                                        </div>
                                    </div>
                                    <div class="step-actions">
                                        <button class="waves-effect waves-dark btn blue next-step" onclick="myAPI()" data-feedback="anyThing">Avanti</button>
                                        <button class="waves-effect waves-dark btn-flat previous-step">Indietro</button>
                                    </div>
                                </div>
                            </li>

                            <li class="step">
                                <div class="step-title waves-effect waves-dark">Risultato</div>

                                <div class="step-content">

                                    <div class="row">

                                        <div id="risultato"></div>
                                        <div id="divLista"></div>
                                    </div>

                                    <div class="step-actions" style="position: static">
                                        <button id="continuaAlSondaggio" class="waves-effect waves-dark btn blue next-step" onclick="creaSondaggio()">Avanti</button>
                                        <button class="waves-effect waves-dark btn-flat previous-step">Indietro</button>

                                    </div>


                                </div>
                            </li>

                            <li class="step">
                                <div class="step-title waves-effect waves-dark">Sondaggio</div>
                                <div class="step-content">
                                    <blockquote>Ti chiediamo per favore di compilare questo sondaggio. Se la visualizzazione ti risulta scomoda, puoi compilarlo anche in un' altra scheda a <a href="javascript:openInNewTab(https://docs.google.com/forms/d/e/1FAIpQLSdpKfmASI77RfLYmZoDBOXBVYXWsIDFGVQyP0W84Ix0vNmaNQ)">questo link</a>.
                                        Grazie!
                                    </blockquote>
                                    <div>
                                        <div id="surveyContainer"></div>
                                    </div>

                                </div>
                                <div class="step-actions">
                                    <button class="waves-effect waves-dark btn-flat previous-step">Indietro</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        if (!(typeof(componentHandler) == 'undefined')) {
            componentHandler.upgradeAllRegistered();
        }

        function anyThing(destroyFeedback) {
            setTimeout(function() {
                destroyFeedback(true);
            }, 1500);
        }

        function noThing(destroyFeedback) {
            setTimeout(function() {
                destroyFeedback(true);
            }, 10000);
        }

        var stepperDiv = document.querySelector('.stepper');
        console.log(stepperDiv);
        var stepper = new MStepper(stepperDiv);
    </script>


    <script type="text/javascript">
        function myAPI() {
            pulisciStep2();
            email = document.getElementById("email").value;
            url_encoded_email = encodeURIComponent(email)

            console.log('la mail selezionata e ' + email)
            console.log('la mail url encoded e ' + url_encoded_email)


            fetch('./hibp?email=' + url_encoded_email)
                .then(response => response.json())
                .then(data => printBreach(data))
                .catch(e => console.log(e));


        }

        function pulisciStep2() {
            divRisultato = document.getElementById("risultato");
            divRisultato.innerHTML = "";

            divLista = document.getElementById("divLista");
            divLista.innerHTML = "";

            bottoneAlSondaggio = document.getElementById("continuaAlSondaggio");
            bottoneAlSondaggio.disabled = false;
        }

        function openInNewTab(url) {
            window.open(url, '_blank').focus();
        }



        function printBreach(data) {
            console.log(data.ok);
            if (data.ok == "ok") {
                divRisultato = document.getElementById("risultato");
                h2Risultato = document.createElement('h2');
                blockquoteRisultato = document.createElement('blockquote');
                blockquoteRisultato.innerHTML = "Il tuo indirizzo e-mail non risulta in nessuno dei data breach a nostra conoscenza. Puoi provare con un" +
                    " altro indirizzo o abbandonare il sito. Grazie!";
                h2Risultato.innerHTML = "Buone notizie!";
                divRisultato.appendChild(h2Risultato);
                divRisultato.appendChild(blockquoteRisultato);
                bottoneAlSondaggio = document.getElementById("continuaAlSondaggio");
                bottoneAlSondaggio.disabled = "true";
            } else {
                divRisultato = document.getElementById("risultato");
                h2Risultato = document.createElement('h2');
                blockquoteRisultato = document.createElement('blockquote');
                blockquoteRisultato.innerHTML = "Il tuo indirizzo e-mail è stato trovato in " + data.length + " data breach. Di seguito la lista.";
                h2Risultato.innerHTML = "Pessime notizie!";
                divRisultato.appendChild(h2Risultato);
                divRisultato.appendChild(blockquoteRisultato);
                divLista = document.getElementById("divLista");
                lista = document.createElement('ul');
                lista.className = "collection";
                divLista.appendChild(lista);
                console.log(data);
                for (i in data) {
                    breach = data[i];
                    elemento = document.createElement('li');
                    elemento.className = "collection-item";
                    lista.appendChild(elemento);
                    elemento.innerHTML = elemento.innerHTML + breach.Name;
                }
            }
            urlemail = "/hibp?email=" + email
        }





        function creaSondaggio() {
            var surveyJSON = {
                pages: [{
                    name: "anagrafica",
                    elements: [{
                        type: "radiogroup",
                        name: "sesso",
                        title: "Sesso",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "M"
                        }, {
                            value: "item2",
                            text: "F"
                        }, {
                            value: "item3",
                            text: "Non-binary"
                        }],
                        hasOther: true,
                        hasNone: true,
                        noneText: "Altro",
                        otherText: "Preferisco non specificare"
                    }, {
                        type: "radiogroup",
                        name: "eta",
                        title: "Età",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "<18"
                        }, {
                            value: "item2",
                            text: "18-24"
                        }, {
                            value: "item3",
                            text: "24-30"
                        }],
                        hasOther: true,
                        hasNone: true,
                        noneText: ">50",
                        otherText: "35-50"
                    }, {
                        type: "radiogroup",
                        name: "question1",
                        title: "Occupazione",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "Sto terminando la scuola superiore"
                        }, {
                            value: "item2",
                            text: "Sto completando la laurea triennale"
                        }, {
                            value: "item3",
                            text: "Sto completando la laurea magistrale"
                        }, {
                            value: "item4",
                            text: "Attualmente sono senza occupazione"
                        }],
                        hasOther: true,
                        hasNone: true,
                        noneText: "Lavoro",
                        otherText: "Sto completando il dottorato/assegno di ricerca"
                    }, {
                        type: "rating",
                        name: "dimestichezza_informatica",
                        title: "Quanta dimestichezza hai con il computer e in generale con l'informatica?",
                        isRequired: true
                    }, {
                        type: "checkbox",
                        name: "question3",
                        title: "Per cosa utilizzi l'indirizzo di posta elettronica che hai inserito prima?",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "Posta elettronica personale"
                        }, {
                            value: "item2",
                            text: "Posta elettronica istituzionale (università)"
                        }, {
                            value: "item3",
                            text: "Posta elettronica professionale (lavoro)"
                        }],
                        hasOther: true,
                        otherText: "Altro (descrivi)"
                    }, {
                        type: "radiogroup",
                        name: "question2",
                        title: "Da quanto tempo usi quell'indirizzo e-mail?",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "Meno di un anno"
                        }, {
                            value: "item2",
                            text: "Meno di cinque anni"
                        }, {
                            value: "item3",
                            text: "Più di cinque anni"
                        }]
                    }, {
                        type: "radiogroup",
                        name: "question4",
                        title: "Condividi con qualcuno quell'indirizzo e-mail?",
                        isRequired: true,
                        choices: [{
                            value: "item1",
                            text: "Sì"
                        }, {
                            value: "item2",
                            text: "No"
                        }]
                    }, {
                        type: "radiogroup",
                        name: "question5",
                        title: "Quanti altri indirizzi e-mail possiedi?",
                        choices: [{
                            value: "item1",
                            text: "Nessun altro"
                        }, {
                            value: "item2",
                            text: "Almeno un altro"
                        }, {
                            value: "item3",
                            text: "Più di due"
                        }]
                    }],
                    title: "Sondaggio"
                }, {
                    name: "page1",
                    elements: [{
                        type: "text",
                        name: "question6",
                        title: "Di quanti data breach sei stat* vittima?",
                        description: "Puoi tornare indietro per ri-controllare",
                        inputType: "number",
                        min: "1"
                    }, {
                        type: "radiogroup",
                        name: "question7",
                        title: "Avevi già usato dei servizi per controllare se il tuo account fosse stato mai rubato? (ad es. hibp.com)",
                        choices: [{
                            value: "item1",
                            text: "Sì"
                        }, {
                            value: "item2",
                            text: "No"
                        }, {
                            value: "item3",
                            text: "Non ricordo"
                        }]
                    }, {
                        type: "text",
                        name: "question8",
                        title: "Quanti tra i siti che ti sono stati mostrati conoscevi?",
                        description: "Se nessuno, allora inserisci 0",
                        inputType: "number"
                    }, {
                        type: "radiogroup",
                        name: "question9",
                        title: "Quale sito ti ha sorpreso di più?",
                        description: "Nota bene: non tutti i nomi che ti abbiamo mostrato corrispondono ad uno specifico sito. A volte è semplicemente il nome con cui il data breach è famoso in rete.",
                        choices: ["item1", "item2", "item3"],
                        choicesByUrl: {
                            url: urlemail
                        }
                    }],
                    title: "Indagine"
                }]
            }

            function sendDataToServer(survey) {
                survey.sendResult('773c5f45-4731-4359-8cbe-ef8e864cf970');
            }

            var survey = new Survey.Model(surveyJSON);
            $("#surveyContainer").Survey({
                model: survey,
                onComplete: sendDataToServer
            });

        }
    </script>

</body>

</html>